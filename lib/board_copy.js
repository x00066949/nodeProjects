/*istanbul ignore next*/'use strict';

var _ = require('lodash');
var rp = require('request-promise');
var regex = require('regex');
var requireEnv = require("require-environment-variables");

var RepoRegex = new regex(/^\/repo*\s[A-Za-z0-9]*\s[0-9]*/);
var IssueRegex = new regex(/^[\/issue]*\s[0-9]*\s(-u|bug|pipeline|-p|events|-e)/);
var EpicRegex = new regex(/^[\/epic]*\s[A-Za-z0-9]*/);
var BlockedRegex = new regex(/^\/blocked/);

module.exports = {

  callMe: function /*istanbul ignore next*/callMe(options) {
    var req = options.request;
    var res = options.response;
    var test = options.test;

    var FinalData = {
      "UserId": "Map",
      "Check": test
    };

    return FinalData;
  },

  checkValidInput: function /*istanbul ignore next*/checkValidInput(options) {
    var req = options.request;
    var res = options.response;
    var ValidBit = false;
    var UserCommand = req.param('command');
    var ValidCommands = ['@scrumbot', '/repo', '/issue', '/epic', '/blocked'];

    if (UserCommand === null || UserCommand === '' || UserCommand === 'undefined') {
      return ValidBit;
    }

    var ValidCommadRegex = new regex(/^(@scrumbot)\s[\/A-Za-z]*/);

    if (!ValidCommadRegex.test(UserCommand)) return ValidBit;

    var CommandArr = UserCommand.split(' ');
    var OriginalsCommandArr = CommandArr;
    CommandArr.splice(0);
    var FinalCommand = CommandArr.join(' ');

    return ValidBit = true;

    // for (var i = 0; i < CommandArr.length; i++) {
    //   var abc = CommandArr[i];
    //   if (_.includes(ValidCommands, CommandArr[i])) {
    //     ValidBit = true;
    //     //return true;
    //   } else if (i == 2) {
    //     return false;
    //   } else {
    //     ValidBit = true;
    //     return false;
    //   }

    // }

    // return ValidBit;
  },

  getCommand: function /*istanbul ignore next*/getCommand(options) {

    var req = options.request;
    var res = options.response;
    var ValidBit = false;
    var UserCommand = req.param('command');

    if (UserCommand === null || UserCommand === '' || UserCommand === 'undefined') {
      return ValidBit;
    }

    var CommandArr = UserCommand.split(' ');
    var OriginalsCommandArr = CommandArr;
    CommandArr.splice(0);
    var FinalCommand = CommandArr.join(' ');

    return FinalCommand;
  },

  validateCommands: function /*istanbul ignore next*/validateCommands(options) {
    var req = options.request;
    var res = options.response;
    var ValidBit = false;

    var RepoId = req.session.repoid;

    var UserCommand = options.Command;
    var CommandArr = UserCommand.split(' ');
    var UrlObject = {
      Url: '',
      Method: 'GET',
      Body: null
    };

    if (RepoRegex.test(UserCommand)) return UrlObject = getRepoUrl(UserCommand, CommandArr);

    if (BlockedRegex.test(UserCommand)) return Url = 'p1/repositories/';

    if (IssueRegex.test(UserCommand)) return Url = getIssueUrl(UserCommand, CommandArr, RepoId);
  },
  makeRequest: function /*istanbul ignore next*/makeRequest(options) {
    var res = options.response;
    var IssueNum = options.issue;
    var Token = process.env.ZENHUB_TOKEN;
    var MainUrl = 'https://api.zenhub.io/';
    var AccessToken = 'access_token=' + Token;
    var UserUrl = 'p1/repositories/117124053/issues/' + IssueNum;

    var UrlOptions = {
      uri: MainUrl + UserUrl,
      qs: {
        access_token: Token // -> uri + '?access_token=xxxxx%20xxxxx'
      },
      headers: {
        'User-Agent': 'Request-Promise'
      },
      json: true // Automatically parses the JSON string in the response
    };

    return rp(UrlOptions).then(function (repos) {
      var Data = repos;
      var IsEpic = Data.is_epic;
      var Pipelines = Data.pipeline;
      console.log('User has Pipelines=' + JSON.stringify(Pipelines));
      return res.json(Data);
    }).catch(function (err) {
      var Error = err;
      // API call failed...
      console.log('User has %d repos', err);
    });
  },

  prepareRequest: function /*istanbul ignore next*/prepareRequest(options) {
    var res = options.response;
    var Configval = sails.config.constants.walson;
    console.log(Configval);
  },

  getRespectiveUrl: function /*istanbul ignore next*/getRespectiveUrl(CommandData) {

    var FinalUrl = '';

    var RepositoryId = 'repos/' + sails.config.constants.GitOwnerName + '/' + RepositoryName;

    var Issueurl = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo;
    var PipeLineurl = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo;

    var IssueEventsurl = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo + '/events';

    var MoveIssuePipeLine = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo + '/moves';
    var MoveBody = {
      pipeline_id: PipeLineId,
      position: PosNo !== null && PosNo !== '' && PosNo !== 'undefined' ? PosNo : 0
    };

    var EpicUrl = 'p1/repositories/' + RespositroyId + '/epics';

    var AddEstimateUrl = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo + '/estimate';
    var EstimateBody = {
      estimate: EstimateNo !== null && PosNo !== '' && PosNo !== 'undefined' ? EstimateNo : 0
    };

    switch (CommandData) {

      case '/blocked':
        FinalUrl = '';
        break;

      case '/epic':
        FinalUrl = '';
        break;

    }
  },

  getRespositoryId: function /*istanbul ignore next*/getRespositoryId(Options) {
    var res = Options.response;
    var req = Options.request;
    var RepositoryName = Options.repoName;
    var Ownername = sails.config.constants.GitOwnerName;

    var RepositoryUrl = 'repos/' + Ownername + '/' + RepositoryName;
    var MainUrl = sails.config.constants.GitHuburl;

    var UrlOptions = {
      uri: MainUrl + RepositoryUrl,
      qs: {
        //access_token: Token // -> uri + '?access_token=xxxxx%20xxxxx'
      },
      headers: {
        'User-Agent': 'Request-Promise'
      },
      json: true // Automatically parses the JSON string in the response
    };

    return rp(UrlOptions).then(function (successdata) {
      var RepoId = successdata.id;
      req.session.RepositoryId = RepoId;
      console.log('Repository Id=' + RepoId);
    }).catch(function (err) {
      var Error = err;
      // API call failed...
      console.log('User has %d repos', err);
    });
  },

  getRepoUrl: function /*istanbul ignore next*/getRepoUrl(UserCommand, CommandArr) {

    var RepositoryName = CommandArr[1];
    var RepositoryId = 'repos/' + sails.config.constants.GitOwnerName + '/' + RepositoryName;

    var UrlObject = {
      Url: RepositoryId,
      Method: 'GET',
      Body: null
    };

    return UrlObject;
  },

  getIssueUrl: function /*istanbul ignore next*/getIssueUrl(UserCommand, CommandArr, RepoId) {
    var RespositroyId = RepoId;

    var UrlObject = {
      Url: '',
      Method: 'GET',
      Body: null
    };

    //To Get State of Pipeline
    var PipelineRegex = new regex(/^\/issue*\s[0-9]*\spipeline/);

    if (PipelineRegex.test(UserCommand)) {

      var IssueNo = CommandArr[1];
      var PipeLineurl = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo;

      var UrlObject = {
        Url: PipeLineurl,
        Method: 'GET',
        Body: null
      };

      return UrlObject;
    }

    // Move Pipeline
    var PipelineMoveRegex = new regex(/^\/issue*\s[0-9]*\s-p\s[A-Za-z0-9]*/);

    if (PipelineMoveRegex.test(UserCommand)) {

      var IssueNo = CommandArr[1];
      var PipeLineId = CommandArr[3];
      var PosNo = CommandArr[4];

      var MoveIssuePipeLine = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo + '/moves';

      var MoveBody = {
        pipeline_id: PipeLineId,
        position: PosNo !== null && PosNo !== '' && PosNo !== 'undefined' ? PosNo : 0
      };

      var UrlObject = {
        Url: MoveIssuePipeLine,
        Method: 'POST',
        Body: MoveBody
      };

      return UrlObject;
    }

    // Get events for the Issue
    var EventsRegex = new regex(/^\/issue*\s[0-9]*\sevents/);

    if (EventsRegex.test(UserCommand)) {

      var IssueNo = CommandArr[1];
      var EstimateNo = CommandArr[3];

      var AddEstimateUrl = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo + '/estimate';
      var EstimateBody = {
        estimate: EstimateNo !== null && EstimateNo !== '' && EstimateNo !== 'undefined' ? EstimateNo : 0
      };

      var UrlObject = {
        Url: AddEstimateUrl,
        Method: 'PUT',
        Body: EstimateBody
      };

      return UrlObject;
    }

    // Get the estimate for the issue.
    var EstimateAddRegex = new regex(/^\/issue*\s[0-9]*\s-e\s[0-9]*/);

    if (EstimateAddRegex.test(UserCommand)) {

      var IssueNo = CommandArr[1];
      var PipeLineId = CommandArr[3];
      var PosNo = CommandArr[4];

      var MoveIssuePipeLine = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo + '/moves';

      var MoveBody = {
        pipeline_id: PipeLineId,
        position: PosNo !== null && PosNo !== '' && PosNo !== 'undefined' ? PosNo : 0
      };

      var UrlObject = {
        Url: MoveIssuePipeLine,
        Method: 'POST',
        Body: MoveBody
      };

      return UrlObject;
    }

    // Get Bugs by the user
    var BugRegex = new regex(/^\/issue*\s[0-9]*\sbug/);

    if (BugRegex.test(UserCommand)) {

      var IssueNo = CommandArr[1];

      var BugUrl = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo + '/estimate';

      var UrlObject = {
        Url: BugUrl,
        Method: 'GET',
        Body: null
      };

      return UrlObject;
    }

    //To Get User Issue by user
    var UserRegex = new regex(/^\/issue*\s[0-9]*\s-u\s[A-Za-z0-9]*/);

    if (UserRegex.test(UserCommand)) {

      var UserUrl = '';

      var UrlObject = {
        Url: UserUrl,
        Method: 'GET',
        Body: null
      };

      return UrlObject;
    }
  },

  getBlockUrl: function /*istanbul ignore next*/getBlockUrl(UserCommand, CommandArr) {

    var RepositoryName = CommandArr[1];
    var RepositoryId = 'repos/' + sails.config.constants.GitOwnerName + '/' + RepositoryName;

    var UrlObject = {
      Url: RepositoryId,
      Method: 'GET',
      Body: null
    };

    return UrlObject;
  }

};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9ib2FyZF9jb3B5LmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwicnAiLCJyZWdleCIsInJlcXVpcmVFbnYiLCJSZXBvUmVnZXgiLCJJc3N1ZVJlZ2V4IiwiRXBpY1JlZ2V4IiwiQmxvY2tlZFJlZ2V4IiwibW9kdWxlIiwiZXhwb3J0cyIsImNhbGxNZSIsIm9wdGlvbnMiLCJyZXEiLCJyZXF1ZXN0IiwicmVzIiwicmVzcG9uc2UiLCJ0ZXN0IiwiRmluYWxEYXRhIiwiY2hlY2tWYWxpZElucHV0IiwiVmFsaWRCaXQiLCJVc2VyQ29tbWFuZCIsInBhcmFtIiwiVmFsaWRDb21tYW5kcyIsIlZhbGlkQ29tbWFkUmVnZXgiLCJDb21tYW5kQXJyIiwic3BsaXQiLCJPcmlnaW5hbHNDb21tYW5kQXJyIiwic3BsaWNlIiwiRmluYWxDb21tYW5kIiwiam9pbiIsImdldENvbW1hbmQiLCJ2YWxpZGF0ZUNvbW1hbmRzIiwiUmVwb0lkIiwic2Vzc2lvbiIsInJlcG9pZCIsIkNvbW1hbmQiLCJVcmxPYmplY3QiLCJVcmwiLCJNZXRob2QiLCJCb2R5IiwiZ2V0UmVwb1VybCIsImdldElzc3VlVXJsIiwibWFrZVJlcXVlc3QiLCJJc3N1ZU51bSIsImlzc3VlIiwiVG9rZW4iLCJwcm9jZXNzIiwiZW52IiwiWkVOSFVCX1RPS0VOIiwiTWFpblVybCIsIkFjY2Vzc1Rva2VuIiwiVXNlclVybCIsIlVybE9wdGlvbnMiLCJ1cmkiLCJxcyIsImFjY2Vzc190b2tlbiIsImhlYWRlcnMiLCJqc29uIiwidGhlbiIsInJlcG9zIiwiRGF0YSIsIklzRXBpYyIsImlzX2VwaWMiLCJQaXBlbGluZXMiLCJwaXBlbGluZSIsImNvbnNvbGUiLCJsb2ciLCJKU09OIiwic3RyaW5naWZ5IiwiY2F0Y2giLCJlcnIiLCJFcnJvciIsInByZXBhcmVSZXF1ZXN0IiwiQ29uZmlndmFsIiwic2FpbHMiLCJjb25maWciLCJjb25zdGFudHMiLCJ3YWxzb24iLCJnZXRSZXNwZWN0aXZlVXJsIiwiQ29tbWFuZERhdGEiLCJGaW5hbFVybCIsIlJlcG9zaXRvcnlJZCIsIkdpdE93bmVyTmFtZSIsIlJlcG9zaXRvcnlOYW1lIiwiSXNzdWV1cmwiLCJSZXNwb3NpdHJveUlkIiwiSXNzdWVObyIsIlBpcGVMaW5ldXJsIiwiSXNzdWVFdmVudHN1cmwiLCJNb3ZlSXNzdWVQaXBlTGluZSIsIk1vdmVCb2R5IiwicGlwZWxpbmVfaWQiLCJQaXBlTGluZUlkIiwicG9zaXRpb24iLCJQb3NObyIsIkVwaWNVcmwiLCJBZGRFc3RpbWF0ZVVybCIsIkVzdGltYXRlQm9keSIsImVzdGltYXRlIiwiRXN0aW1hdGVObyIsImdldFJlc3Bvc2l0b3J5SWQiLCJPcHRpb25zIiwicmVwb05hbWUiLCJPd25lcm5hbWUiLCJSZXBvc2l0b3J5VXJsIiwiR2l0SHVidXJsIiwic3VjY2Vzc2RhdGEiLCJpZCIsIlBpcGVsaW5lUmVnZXgiLCJQaXBlbGluZU1vdmVSZWdleCIsIkV2ZW50c1JlZ2V4IiwiRXN0aW1hdGVBZGRSZWdleCIsIkJ1Z1JlZ2V4IiwiQnVnVXJsIiwiVXNlclJlZ2V4IiwiZ2V0QmxvY2tVcmwiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSUEsSUFBSUMsUUFBUSxRQUFSLENBQVI7QUFDQSxJQUFJQyxLQUFLRCxRQUFRLGlCQUFSLENBQVQ7QUFDQSxJQUFJRSxRQUFRRixRQUFRLE9BQVIsQ0FBWjtBQUNBLElBQUlHLGFBQWFILFFBQVEsK0JBQVIsQ0FBakI7O0FBR0EsSUFBSUksWUFBWSxJQUFJRixLQUFKLENBQVUsZ0NBQVYsQ0FBaEI7QUFDQSxJQUFJRyxhQUFhLElBQUlILEtBQUosQ0FBVSxxREFBVixDQUFqQjtBQUNBLElBQUlJLFlBQVksSUFBSUosS0FBSixDQUFVLDBCQUFWLENBQWhCO0FBQ0EsSUFBSUssZUFBZSxJQUFJTCxLQUFKLENBQVUsWUFBVixDQUFuQjs7QUFHQU0sT0FBT0MsT0FBUCxHQUFpQjs7QUFHZkMsVUFBUSx3Q0FBVUMsT0FBVixFQUFtQjtBQUN6QixRQUFJQyxNQUFNRCxRQUFRRSxPQUFs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QUFFQSxRQUFJL0MsWUFBWTtBQUNkQyxXQUFLNEMsWUFEUztBQUVkM0MsY0FBUSxLQUZNO0FBR2RDLFlBQU07QUFIUSxLQUFoQjs7QUFNQSxXQUFPSCxTQUFQO0FBQ0Q7O0FBdFpjLENBQWpCIiwiZmlsZSI6ImJvYXJkX2NvcHkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xudmFyIHJwID0gcmVxdWlyZSgncmVxdWVzdC1wcm9taXNlJyk7XG52YXIgcmVnZXggPSByZXF1aXJlKCdyZWdleCcpO1xudmFyIHJlcXVpcmVFbnYgPSByZXF1aXJlKFwicmVxdWlyZS1lbnZpcm9ubWVudC12YXJpYWJsZXNcIik7XG5cblxudmFyIFJlcG9SZWdleCA9IG5ldyByZWdleCgvXlxcL3JlcG8qXFxzW0EtWmEtejAtOV0qXFxzWzAtOV0qLyk7XG52YXIgSXNzdWVSZWdleCA9IG5ldyByZWdleCgvXltcXC9pc3N1ZV0qXFxzWzAtOV0qXFxzKC11fGJ1Z3xwaXBlbGluZXwtcHxldmVudHN8LWUpLyk7XG52YXIgRXBpY1JlZ2V4ID0gbmV3IHJlZ2V4KC9eW1xcL2VwaWNdKlxcc1tBLVphLXowLTldKi8pO1xudmFyIEJsb2NrZWRSZWdleCA9IG5ldyByZWdleCgvXlxcL2Jsb2NrZWQvKTtcblxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcblxuXG4gIGNhbGxNZTogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICB2YXIgcmVxID0gb3B0aW9ucy5yZXF1ZXN0O1xuICAgIHZhciByZXMgPSBvcHRpb25zLnJlc3BvbnNlO1xuICAgIHZhciB0ZXN0ID0gb3B0aW9ucy50ZXN0O1xuXG4gICAgdmFyIEZpbmFsRGF0YSA9IHtcbiAgICAgIFwiVXNlcklkXCI6IFwiTWFwXCIsXG4gICAgICBcIkNoZWNrXCI6IHRlc3RcbiAgICB9O1xuXG4gICAgcmV0dXJuIEZpbmFsRGF0YTtcbiAgfSxcblxuICBjaGVja1ZhbGlkSW5wdXQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgdmFyIHJlcSA9IG9wdGlvbnMucmVxdWVzdDtcbiAgICB2YXIgcmVzID0gb3B0aW9ucy5yZXNwb25zZTtcbiAgICB2YXIgVmFsaWRCaXQgPSBmYWxzZTtcbiAgICB2YXIgVXNlckNvbW1hbmQgPSByZXEucGFyYW0oJ2NvbW1hbmQnKTtcbiAgICB2YXIgVmFsaWRDb21tYW5kcyA9IFsnQHNjcnVtYm90JywgJy9yZXBvJywgJy9pc3N1ZScsICcvZXBpYycsICcvYmxvY2tlZCddO1xuXG4gICAgaWYgKFVzZXJDb21tYW5kID09PSBudWxsIHx8IFVzZXJDb21tYW5kID09PSAnJyB8fCBVc2VyQ29tbWFuZCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHJldHVybiBWYWxpZEJpdDtcbiAgICB9XG5cbiAgICB2YXIgVmFsaWRDb21tYWRSZWdleCA9IG5ldyByZWdleCgvXihAc2NydW1ib3QpXFxzW1xcL0EtWmEtel0qLyk7XG5cbiAgICBpZiAoIVZhbGlkQ29tbWFkUmVnZXgudGVzdChVc2VyQ29tbWFuZCkpXG4gICAgICByZXR1cm4gVmFsaWRCaXQ7XG5cbiAgICB2YXIgQ29tbWFuZEFyciA9IFVzZXJDb21tYW5kLnNwbGl0KCcgJyk7XG4gICAgdmFyIE9yaWdpbmFsc0NvbW1hbmRBcnIgPSBDb21tYW5kQXJyO1xuICAgIENvbW1hbmRBcnIuc3BsaWNlKDApO1xuICAgIHZhciBGaW5hbENvbW1hbmQgPSBDb21tYW5kQXJyLmpvaW4oJyAnKTtcblxuICAgIHJldHVybiBWYWxpZEJpdCA9IHRydWU7XG5cblxuXG5cblxuICAgIC8vIGZvciAodmFyIGkgPSAwOyBpIDwgQ29tbWFuZEFyci5sZW5ndGg7IGkrKykge1xuICAgIC8vICAgdmFyIGFiYyA9IENvbW1hbmRBcnJbaV07XG4gICAgLy8gICBpZiAoXy5pbmNsdWRlcyhWYWxpZENvbW1hbmRzLCBDb21tYW5kQXJyW2ldKSkge1xuICAgIC8vICAgICBWYWxpZEJpdCA9IHRydWU7XG4gICAgLy8gICAgIC8vcmV0dXJuIHRydWU7XG4gICAgLy8gICB9IGVsc2UgaWYgKGkgPT0gMikge1xuICAgIC8vICAgICByZXR1cm4gZmFsc2U7XG4gICAgLy8gICB9IGVsc2Uge1xuICAgIC8vICAgICBWYWxpZEJpdCA9IHRydWU7XG4gICAgLy8gICAgIHJldHVybiBmYWxzZTtcbiAgICAvLyAgIH1cblxuICAgIC8vIH1cblxuICAgIC8vIHJldHVybiBWYWxpZEJpdDtcbiAgfSxcblxuICBnZXRDb21tYW5kOiBmdW5jdGlvbiAob3B0aW9ucykge1xuXG4gICAgdmFyIHJlcSA9IG9wdGlvbnMucmVxdWVzdDtcbiAgICB2YXIgcmVzID0gb3B0aW9ucy5yZXNwb25zZTtcbiAgICB2YXIgVmFsaWRCaXQgPSBmYWxzZTtcbiAgICB2YXIgVXNlckNvbW1hbmQgPSByZXEucGFyYW0oJ2NvbW1hbmQnKTtcblxuXG4gICAgaWYgKFVzZXJDb21tYW5kID09PSBudWxsIHx8IFVzZXJDb21tYW5kID09PSAnJyB8fCBVc2VyQ29tbWFuZCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHJldHVybiBWYWxpZEJpdDtcbiAgICB9XG5cbiAgICB2YXIgQ29tbWFuZEFyciA9IFVzZXJDb21tYW5kLnNwbGl0KCcgJyk7XG4gICAgdmFyIE9yaWdpbmFsc0NvbW1hbmRBcnIgPSBDb21tYW5kQXJyO1xuICAgIENvbW1hbmRBcnIuc3BsaWNlKDApO1xuICAgIHZhciBGaW5hbENvbW1hbmQgPSBDb21tYW5kQXJyLmpvaW4oJyAnKTtcblxuICAgIHJldHVybiBGaW5hbENvbW1hbmQ7XG4gIH0sXG5cbiAgdmFsaWRhdGVDb21tYW5kczogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICB2YXIgcmVxID0gb3B0aW9ucy5yZXF1ZXN0O1xuICAgIHZhciByZXMgPSBvcHRpb25zLnJlc3BvbnNlO1xuICAgIHZhciBWYWxpZEJpdCA9IGZhbHNlO1xuXG4gICAgdmFyIFJlcG9JZD1yZXEuc2Vzc2lvbi5yZXBvaWQ7XG4gICAgXG4gICAgdmFyIFVzZXJDb21tYW5kID0gb3B0aW9ucy5Db21tYW5kO1xuICAgIHZhciBDb21tYW5kQXJyID0gVXNlckNvbW1hbmQuc3BsaXQoJyAnKTtcbiAgICB2YXIgVXJsT2JqZWN0ID0ge1xuICAgICAgVXJsOiAnJyxcbiAgICAgIE1ldGhvZDogJ0dFVCcsXG4gICAgICBCb2R5IDogbnVsbFxuICAgIH07XG5cbiAgXG5cbiAgICBpZiAoUmVwb1JlZ2V4LnRlc3QoVXNlckNvbW1hbmQpKVxuICAgICAgcmV0dXJuIFVybE9iamVjdCA9IGdldFJlcG9VcmwoVXNlckNvbW1hbmQsIENvbW1hbmRBcnIpO1xuXG4gICAgaWYgKEJsb2NrZWRSZWdleC50ZXN0KFVzZXJDb21tYW5kKSlcbiAgICAgIHJldHVybiBVcmwgPSAncDEvcmVwb3NpdG9yaWVzLyc7XG5cbiAgICBpZiAoSXNzdWVSZWdleC50ZXN0KFVzZXJDb21tYW5kKSlcbiAgICAgIHJldHVybiBVcmwgPSBnZXRJc3N1ZVVybChVc2VyQ29tbWFuZCwgQ29tbWFuZEFycixSZXBvSWQpO1xuXG4gIH0sXG4gIG1ha2VSZXF1ZXN0OiBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgIHZhciByZXMgPSBvcHRpb25zLnJlc3BvbnNlO1xuICAgIHZhciBJc3N1ZU51bSA9IG9wdGlvbnMuaXNzdWU7XG4gICAgdmFyIFRva2VuID0gcHJvY2Vzcy5lbnYuWkVOSFVCX1RPS0VOO1xuICAgIHZhciBNYWluVXJsID0gJ2h0dHBzOi8vYXBpLnplbmh1Yi5pby8nO1xuICAgIHZhciBBY2Nlc3NUb2tlbiA9ICdhY2Nlc3NfdG9rZW49JyArIFRva2VuO1xuICAgIHZhciBVc2VyVXJsID0gJ3AxL3JlcG9zaXRvcmllcy8xMTcxMjQwNTMvaXNzdWVzLycrSXNzdWVOdW07XG5cblxuXG4gICAgdmFyIFVybE9wdGlvbnMgPSB7XG4gICAgICB1cmk6IE1haW5VcmwgKyBVc2VyVXJsLFxuICAgICAgcXM6IHtcbiAgICAgICAgYWNjZXNzX3Rva2VuOiBUb2tlbiAvLyAtPiB1cmkgKyAnP2FjY2Vzc190b2tlbj14eHh4eCUyMHh4eHh4J1xuICAgICAgfSxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ1VzZXItQWdlbnQnOiAnUmVxdWVzdC1Qcm9taXNlJ1xuICAgICAgfSxcbiAgICAgIGpzb246IHRydWUgLy8gQXV0b21hdGljYWxseSBwYXJzZXMgdGhlIEpTT04gc3RyaW5nIGluIHRoZSByZXNwb25zZVxuICAgIH07XG5cbiAgICByZXR1cm4gcnAoVXJsT3B0aW9ucylcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXBvcykge1xuICAgICAgICB2YXIgRGF0YSA9IHJlcG9zO1xuICAgICAgICB2YXIgSXNFcGljID0gRGF0YS5pc19lcGljO1xuICAgICAgICB2YXIgUGlwZWxpbmVzID0gRGF0YS5waXBlbGluZTtcbiAgICAgICAgY29uc29sZS5sb2coJ1VzZXIgaGFzIFBpcGVsaW5lcz0nICsgSlNPTi5zdHJpbmdpZnkoUGlwZWxpbmVzKSk7XG4gICAgICAgIHJldHVybiByZXMuanNvbihEYXRhKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICB2YXIgRXJyb3IgPSBlcnI7XG4gICAgICAgIC8vIEFQSSBjYWxsIGZhaWxlZC4uLlxuICAgICAgICBjb25zb2xlLmxvZygnVXNlciBoYXMgJWQgcmVwb3MnLCBlcnIpO1xuICAgICAgfSk7XG5cblxuICB9LFxuXG4gIHByZXBhcmVSZXF1ZXN0OiBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgdmFyIHJlcyA9IG9wdGlvbnMucmVzcG9uc2U7XG4gICAgICB2YXIgQ29uZmlndmFsID0gc2FpbHMuY29uZmlnLmNvbnN0YW50cy53YWxzb247XG4gICAgICBjb25zb2xlLmxvZyhDb25maWd2YWwpO1xuXG5cbiAgICB9XG5cbiAgICAsXG5cbiAgZ2V0UmVzcGVjdGl2ZVVybDogZnVuY3Rpb24gKENvbW1hbmREYXRhKSB7XG5cbiAgICB2YXIgRmluYWxVcmwgPSAnJztcblxuICAgIHZhciBSZXBvc2l0b3J5SWQgPSAncmVwb3MvJyArIHNhaWxzLmNvbmZpZy5jb25zdGFudHMuR2l0T3duZXJOYW1lICsgJy8nICsgUmVwb3NpdG9yeU5hbWU7XG5cbiAgICB2YXIgSXNzdWV1cmwgPSAncDEvcmVwb3NpdG9yaWVzLycgKyBSZXNwb3NpdHJveUlkICsgJy9pc3N1ZXMvJyArIElzc3VlTm87XG4gICAgdmFyIFBpcGVMaW5ldXJsID0gJ3AxL3JlcG9zaXRvcmllcy8nICsgUmVzcG9zaXRyb3lJZCArICcvaXNzdWVzLycgKyBJc3N1ZU5vO1xuXG4gICAgdmFyIElzc3VlRXZlbnRzdXJsID0gJ3AxL3JlcG9zaXRvcmllcy8nICsgUmVzcG9zaXRyb3lJZCArICcvaXNzdWVzLycgKyBJc3N1ZU5vICsgJy9ldmVudHMnO1xuXG4gICAgdmFyIE1vdmVJc3N1ZVBpcGVMaW5lID0gJ3AxL3JlcG9zaXRvcmllcy8nICsgUmVzcG9zaXRyb3lJZCArICcvaXNzdWVzLycgKyBJc3N1ZU5vICsgJy9tb3Zlcyc7XG4gICAgdmFyIE1vdmVCb2R5ID0ge1xuICAgICAgcGlwZWxpbmVfaWQ6IFBpcGVMaW5lSWQsXG4gICAgICBwb3NpdGlvbjogKFBvc05vICE9PSBudWxsICYmIFBvc05vICE9PSAnJyAmJiBQb3NObyAhPT0gJ3VuZGVmaW5lZCcgPyBQb3NObyA6IDApXG4gICAgfTtcblxuXG4gICAgdmFyIEVwaWNVcmwgPSAncDEvcmVwb3NpdG9yaWVzLycgKyBSZXNwb3NpdHJveUlkICsgJy9lcGljcyc7XG5cbiAgICB2YXIgQWRkRXN0aW1hdGVVcmwgPSAncDEvcmVwb3NpdG9yaWVzLycgKyBSZXNwb3NpdHJveUlkICsgJy9pc3N1ZXMvJyArIElzc3VlTm8gKyAnL2VzdGltYXRlJztcbiAgICB2YXIgRXN0aW1hdGVCb2R5ID0ge1xuICAgICAgZXN0aW1hdGU6IChFc3RpbWF0ZU5vICE9PSBudWxsICYmIFBvc05vICE9PSAnJyAmJiBQb3NObyAhPT0gJ3VuZGVmaW5lZCcgPyBFc3RpbWF0ZU5vIDogMClcbiAgICB9O1xuXG5cblxuICAgIHN3aXRjaCAoQ29tbWFuZERhdGEpIHtcblxuXG5cbiAgICAgIGNhc2UgJy9ibG9ja2VkJzpcbiAgICAgICAgRmluYWxVcmwgPSAnJztcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJy9lcGljJzpcbiAgICAgICAgRmluYWxVcmwgPSAnJztcbiAgICAgICAgYnJlYWs7XG5cbiAgICB9XG5cbiAgfSxcblxuICBnZXRSZXNwb3NpdG9yeUlkOiBmdW5jdGlvbiAoT3B0aW9ucykge1xuICAgIHZhciByZXMgPSBPcHRpb25zLnJlc3BvbnNlO1xuICAgIHZhciByZXEgPSBPcHRpb25zLnJlcXVlc3Q7XG4gICAgdmFyIFJlcG9zaXRvcnlOYW1lID0gT3B0aW9ucy5yZXBvTmFtZTtcbiAgICB2YXIgT3duZXJuYW1lID0gc2FpbHMuY29uZmlnLmNvbnN0YW50cy5HaXRPd25lck5hbWU7XG5cbiAgICB2YXIgUmVwb3NpdG9yeVVybCA9ICdyZXBvcy8nICsgT3duZXJuYW1lICsgJy8nICsgUmVwb3NpdG9yeU5hbWU7XG4gICAgdmFyIE1haW5VcmwgPSBzYWlscy5jb25maWcuY29uc3RhbnRzLkdpdEh1YnVybDtcblxuICAgIHZhciBVcmxPcHRpb25zID0ge1xuICAgICAgdXJpOiBNYWluVXJsICsgUmVwb3NpdG9yeVVybCxcbiAgICAgIHFzOiB7XG4gICAgICAgIC8vYWNjZXNzX3Rva2VuOiBUb2tlbiAvLyAtPiB1cmkgKyAnP2FjY2Vzc190b2tlbj14eHh4eCUyMHh4eHh4J1xuICAgICAgfSxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ1VzZXItQWdlbnQnOiAnUmVxdWVzdC1Qcm9taXNlJ1xuICAgICAgfSxcbiAgICAgIGpzb246IHRydWUgLy8gQXV0b21hdGljYWxseSBwYXJzZXMgdGhlIEpTT04gc3RyaW5nIGluIHRoZSByZXNwb25zZVxuICAgIH07XG5cbiAgICByZXR1cm4gcnAoVXJsT3B0aW9ucylcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChzdWNjZXNzZGF0YSkge1xuICAgICAgICB2YXIgUmVwb0lkID0gc3VjY2Vzc2RhdGEuaWQ7XG4gICAgICAgIHJlcS5zZXNzaW9uLlJlcG9zaXRvcnlJZCA9IFJlcG9JZDtcbiAgICAgICAgY29uc29sZS5sb2coJ1JlcG9zaXRvcnkgSWQ9JyArIFJlcG9JZCk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgdmFyIEVycm9yID0gZXJyO1xuICAgICAgICAvLyBBUEkgY2FsbCBmYWlsZWQuLi5cbiAgICAgICAgY29uc29sZS5sb2coJ1VzZXIgaGFzICVkIHJlcG9zJywgZXJyKTtcbiAgICAgIH0pO1xuXG4gIH0sXG5cbiAgZ2V0UmVwb1VybDogZnVuY3Rpb24gKFVzZXJDb21tYW5kLCBDb21tYW5kQXJyKSB7XG5cbiAgICB2YXIgUmVwb3NpdG9yeU5hbWUgPSBDb21tYW5kQXJyWzFdO1xuICAgIHZhciBSZXBvc2l0b3J5SWQgPSAncmVwb3MvJyArIHNhaWxzLmNvbmZpZy5jb25zdGFudHMuR2l0T3duZXJOYW1lICsgJy8nICsgUmVwb3NpdG9yeU5hbWU7XG5cbiAgICB2YXIgVXJsT2JqZWN0ID0ge1xuICAgICAgVXJsOiBSZXBvc2l0b3J5SWQsXG4gICAgICBNZXRob2Q6ICdHRVQnLFxuICAgICAgQm9keTogbnVsbFxuICAgIH07XG5cbiAgICByZXR1cm4gVXJsT2JqZWN0O1xuICB9LFxuXG4gIGdldElzc3VlVXJsOiBmdW5jdGlvbiAoVXNlckNvbW1hbmQsIENvbW1hbmRBcnIsUmVwb0lkKSB7XG4gICAgdmFyIFJlc3Bvc2l0cm95SWQgPSBSZXBvSWQ7XG5cbiAgICB2YXIgVXJsT2JqZWN0ID0ge1xuICAgICAgVXJsOiAnJyxcbiAgICAgIE1ldGhvZDogJ0dFVCcsXG4gICAgICBCb2R5OiBudWxsXG4gICAgfTtcblxuXG5cblxuICAgIC8vVG8gR2V0IFN0YXRlIG9mIFBpcGVsaW5lXG4gICAgdmFyIFBpcGVsaW5lUmVnZXggPSBuZXcgcmVnZXgoL15cXC9pc3N1ZSpcXHNbMC05XSpcXHNwaXBlbGluZS8pO1xuXG4gICAgaWYgKFBpcGVsaW5lUmVnZXgudGVzdChVc2VyQ29tbWFuZCkpIHtcblxuICAgICAgdmFyIElzc3VlTm8gPSBDb21tYW5kQXJyWzFdO1xuICAgICAgdmFyIFBpcGVMaW5ldXJsID0gJ3AxL3JlcG9zaXRvcmllcy8nICsgUmVzcG9zaXRyb3lJZCArICcvaXNzdWVzLycgKyBJc3N1ZU5vO1xuXG4gICAgICB2YXIgVXJsT2JqZWN0ID0ge1xuICAgICAgICBVcmw6IFBpcGVMaW5ldXJsLFxuICAgICAgICBNZXRob2Q6ICdHRVQnLFxuICAgICAgICBCb2R5OiBudWxsXG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gVXJsT2JqZWN0O1xuICAgIH1cblxuXG4gICAgLy8gTW92ZSBQaXBlbGluZVxuICAgIHZhciBQaXBlbGluZU1vdmVSZWdleCA9IG5ldyByZWdleCgvXlxcL2lzc3VlKlxcc1swLTldKlxccy1wXFxzW0EtWmEtejAtOV0qLyk7XG5cbiAgICBpZiAoUGlwZWxpbmVNb3ZlUmVnZXgudGVzdChVc2VyQ29tbWFuZCkpIHtcblxuICAgICAgdmFyIElzc3VlTm8gPSBDb21tYW5kQXJyWzFdO1xuICAgICAgdmFyIFBpcGVMaW5lSWQgPSBDb21tYW5kQXJyWzNdO1xuICAgICAgdmFyIFBvc05vID0gQ29tbWFuZEFycls0XTtcblxuICAgICAgdmFyIE1vdmVJc3N1ZVBpcGVMaW5lID0gJ3AxL3JlcG9zaXRvcmllcy8nICsgUmVzcG9zaXRyb3lJZCArICcvaXNzdWVzLycgKyBJc3N1ZU5vICsgJy9tb3Zlcyc7XG5cbiAgICAgIHZhciBNb3ZlQm9keSA9IHtcbiAgICAgICAgcGlwZWxpbmVfaWQ6IFBpcGVMaW5lSWQsXG4gICAgICAgIHBvc2l0aW9uOiAoUG9zTm8gIT09IG51bGwgJiYgUG9zTm8gIT09ICcnICYmIFBvc05vICE9PSAndW5kZWZpbmVkJyA/IFBvc05vIDogMClcbiAgICAgIH07XG5cbiAgICAgIHZhciBVcmxPYmplY3QgPSB7XG4gICAgICAgIFVybDogTW92ZUlzc3VlUGlwZUxpbmUsXG4gICAgICAgIE1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBCb2R5OiBNb3ZlQm9keVxuICAgICAgfTtcblxuICAgICAgcmV0dXJuIFVybE9iamVjdDtcbiAgICB9XG5cblxuICAgIC8vIEdldCBldmVudHMgZm9yIHRoZSBJc3N1ZVxuICAgIHZhciBFdmVudHNSZWdleCA9IG5ldyByZWdleCgvXlxcL2lzc3VlKlxcc1swLTldKlxcc2V2ZW50cy8pO1xuXG4gICAgaWYgKEV2ZW50c1JlZ2V4LnRlc3QoVXNlckNvbW1hbmQpKSB7XG5cbiAgICAgIHZhciBJc3N1ZU5vID0gQ29tbWFuZEFyclsxXTtcbiAgICAgIHZhciBFc3RpbWF0ZU5vID0gQ29tbWFuZEFyclszXTtcblxuICAgICAgdmFyIEFkZEVzdGltYXRlVXJsID0gJ3AxL3JlcG9zaXRvcmllcy8nICsgUmVzcG9zaXRyb3lJZCArICcvaXNzdWVzLycgKyBJc3N1ZU5vICsgJy9lc3RpbWF0ZSc7XG4gICAgICB2YXIgRXN0aW1hdGVCb2R5ID0ge1xuICAgICAgICBlc3RpbWF0ZTogKEVzdGltYXRlTm8gIT09IG51bGwgJiYgRXN0aW1hdGVObyAhPT0gJycgJiYgRXN0aW1hdGVObyAhPT0gJ3VuZGVmaW5lZCcgPyBFc3RpbWF0ZU5vIDogMClcbiAgICAgIH07XG5cbiAgICAgIHZhciBVcmxPYmplY3QgPSB7XG4gICAgICAgIFVybDogQWRkRXN0aW1hdGVVcmwsXG4gICAgICAgIE1ldGhvZDogJ1BVVCcsXG4gICAgICAgIEJvZHk6IEVzdGltYXRlQm9keVxuICAgICAgfTtcblxuICAgICAgcmV0dXJuIFVybE9iamVjdDtcbiAgICB9XG5cblxuXG4gICAgLy8gR2V0IHRoZSBlc3RpbWF0ZSBmb3IgdGhlIGlzc3VlLlxuICAgIHZhciBFc3RpbWF0ZUFkZFJlZ2V4ID0gbmV3IHJlZ2V4KC9eXFwvaXNzdWUqXFxzWzAtOV0qXFxzLWVcXHNbMC05XSovKTtcblxuICAgIGlmIChFc3RpbWF0ZUFkZFJlZ2V4LnRlc3QoVXNlckNvbW1hbmQpKSB7XG5cbiAgICAgIHZhciBJc3N1ZU5vID0gQ29tbWFuZEFyclsxXTtcbiAgICAgIHZhciBQaXBlTGluZUlkID0gQ29tbWFuZEFyclszXTtcbiAgICAgIHZhciBQb3NObyA9IENvbW1hbmRBcnJbNF07XG5cbiAgICAgIHZhciBNb3ZlSXNzdWVQaXBlTGluZSA9ICdwMS9yZXBvc2l0b3JpZXMvJyArIFJlc3Bvc2l0cm95SWQgKyAnL2lzc3Vlcy8nICsgSXNzdWVObyArICcvbW92ZXMnO1xuXG4gICAgICB2YXIgTW92ZUJvZHkgPSB7XG4gICAgICAgIHBpcGVsaW5lX2lkOiBQaXBlTGluZUlkLFxuICAgICAgICBwb3NpdGlvbjogKFBvc05vICE9PSBudWxsICYmIFBvc05vICE9PSAnJyAmJiBQb3NObyAhPT0gJ3VuZGVmaW5lZCcgPyBQb3NObyA6IDApXG4gICAgICB9O1xuXG4gICAgICB2YXIgVXJsT2JqZWN0ID0ge1xuICAgICAgICBVcmw6IE1vdmVJc3N1ZVBpcGVMaW5lLFxuICAgICAgICBNZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgQm9keTogTW92ZUJvZHlcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiBVcmxPYmplY3Q7XG4gICAgfVxuXG5cblxuICAgIC8vIEdldCBCdWdzIGJ5IHRoZSB1c2VyXG4gICAgdmFyIEJ1Z1JlZ2V4ID0gbmV3IHJlZ2V4KC9eXFwvaXNzdWUqXFxzWzAtOV0qXFxzYnVnLyk7XG5cbiAgICBpZiAoQnVnUmVnZXgudGVzdChVc2VyQ29tbWFuZCkpIHtcblxuICAgICAgdmFyIElzc3VlTm8gPSBDb21tYW5kQXJyWzFdO1xuXG4gICAgICB2YXIgQnVnVXJsID0gJ3AxL3JlcG9zaXRvcmllcy8nICsgUmVzcG9zaXRyb3lJZCArICcvaXNzdWVzLycgKyBJc3N1ZU5vICsgJy9lc3RpbWF0ZSc7XG5cbiAgICAgIHZhciBVcmxPYmplY3QgPSB7XG4gICAgICAgIFVybDogQnVnVXJsLFxuICAgICAgICBNZXRob2Q6ICdHRVQnLFxuICAgICAgICBCb2R5OiBudWxsXG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gVXJsT2JqZWN0O1xuICAgIH1cblxuXG4gICAgLy9UbyBHZXQgVXNlciBJc3N1ZSBieSB1c2VyXG4gICAgdmFyIFVzZXJSZWdleCA9IG5ldyByZWdleCgvXlxcL2lzc3VlKlxcc1swLTldKlxccy11XFxzW0EtWmEtejAtOV0qLyk7XG5cbiAgICBpZiAoVXNlclJlZ2V4LnRlc3QoVXNlckNvbW1hbmQpKSB7XG5cbiAgICAgIHZhciBVc2VyVXJsID0gJyc7XG5cbiAgICAgIHZhciBVcmxPYmplY3QgPSB7XG4gICAgICAgIFVybDogVXNlclVybCxcbiAgICAgICAgTWV0aG9kOiAnR0VUJyxcbiAgICAgICAgQm9keTogbnVsbFxuICAgICAgfTtcblxuICAgICAgcmV0dXJuIFVybE9iamVjdDtcbiAgICB9XG5cblxuXG4gIH1cblxuICAsXG5cbiAgZ2V0QmxvY2tVcmw6IGZ1bmN0aW9uIChVc2VyQ29tbWFuZCwgQ29tbWFuZEFycikge1xuXG4gICAgdmFyIFJlcG9zaXRvcnlOYW1lID0gQ29tbWFuZEFyclsxXTtcbiAgICB2YXIgUmVwb3NpdG9yeUlkID0gJ3JlcG9zLycgKyBzYWlscy5jb25maWcuY29uc3RhbnRzLkdpdE93bmVyTmFtZSArICcvJyArIFJlcG9zaXRvcnlOYW1lO1xuXG4gICAgdmFyIFVybE9iamVjdCA9IHtcbiAgICAgIFVybDogUmVwb3NpdG9yeUlkLFxuICAgICAgTWV0aG9kOiAnR0VUJyxcbiAgICAgIEJvZHk6IG51bGxcbiAgICB9O1xuXG4gICAgcmV0dXJuIFVybE9iamVjdDtcbiAgfSxcblxuXG5cbn07XG4iXX0=