/*istanbul ignore next*/'use strict';

var _ = require('lodash');
var rp = require('request-promise');
var regex = require('regex');
var requireEnv = require("require-environment-variables");

var RepoRegex = new regex(/^\/repo*\s[A-Za-z0-9]*\s[0-9]*/);
var IssueRegex = new regex(/^[\/issue]*\s[0-9]*\s(-u|bug|pipeline|-p|events|-e)/);
var EpicRegex = new regex(/^[\/epic]*\s[A-Za-z0-9]*/);
var BlockedRegex = new regex(/^\/blocked/);

module.exports = {

  callMe: function /*istanbul ignore next*/callMe(options) {
    var req = options.request;
    var res = options.response;
    var test = options.test;

    var FinalData = {
      "UserId": "Map",
      "Check": test
    };

    return FinalData;
  },

  checkValidInput: function /*istanbul ignore next*/checkValidInput(options) {
    var req = options.request;
    var res = options.response;
    var ValidBit = false;
    var UserCommand = req.param('command');
    var ValidCommands = ['@scrumbot', '/repo', '/issue', '/epic', '/blocked'];

    if (UserCommand === null || UserCommand === '' || UserCommand === 'undefined') {
      return ValidBit;
    }

    var ValidCommadRegex = new regex(/^(@scrumbot)\s[\/A-Za-z]*/);

    if (!ValidCommadRegex.test(UserCommand)) return ValidBit;

    var CommandArr = UserCommand.split(' ');
    var OriginalsCommandArr = CommandArr;
    CommandArr.splice(0);
    var FinalCommand = CommandArr.join(' ');

    return ValidBit = true;

    // for (var i = 0; i < CommandArr.length; i++) {
    //   var abc = CommandArr[i];
    //   if (_.includes(ValidCommands, CommandArr[i])) {
    //     ValidBit = true;
    //     //return true;
    //   } else if (i == 2) {
    //     return false;
    //   } else {
    //     ValidBit = true;
    //     return false;
    //   }

    // }

    // return ValidBit;
  },

  getCommand: function /*istanbul ignore next*/getCommand(options) {

    var req = options.request;
    var res = options.response;
    var ValidBit = false;
    var UserCommand = req.param('command');

    if (UserCommand === null || UserCommand === '' || UserCommand === 'undefined') {
      return ValidBit;
    }

    var CommandArr = UserCommand.split(' ');
    var OriginalsCommandArr = CommandArr;
    CommandArr.splice(0);
    var FinalCommand = CommandArr.join(' ');

    return FinalCommand;
  },

  validateCommands: function /*istanbul ignore next*/validateCommands(options) {
    var req = options.request;
    var res = options.response;
    var ValidBit = false;

    var RepoId = req.session.repoid;

    var UserCommand = options.Command;
    var CommandArr = UserCommand.split(' ');
    var UrlObject = {
      Url: '',
      Method: 'GET',
      Body: null
    };

    if (RepoRegex.test(UserCommand)) return UrlObject = getRepoUrl(UserCommand, CommandArr);

    if (BlockedRegex.test(UserCommand)) return Url = 'p1/repositories/';

    if (IssueRegex.test(UserCommand)) return Url = getIssueUrl(UserCommand, CommandArr, RepoId);
  },
  makeRequest: function /*istanbul ignore next*/makeRequest(options) {
    var res = options.response;
    var IssueNum = options.issue;
    var Token = process.env.ZENHUB_TOKEN;
    var MainUrl = 'https://api.zenhub.io/';
    var AccessToken = 'access_token=' + Token;
    var UserUrl = 'p1/repositories/117124053/issues/' + Issue;

    var UrlOptions = {
      uri: MainUrl + UserUrl,
      qs: {
        access_token: Token // -> uri + '?access_token=xxxxx%20xxxxx'
      },
      headers: {
        'User-Agent': 'Request-Promise'
      },
      json: true // Automatically parses the JSON string in the response
    };

    return rp(UrlOptions).then(function (repos) {
      var Data = repos;
      var IsEpic = Data.is_epic;
      var Pipelines = Data.pipeline;
      console.log('User has Pipelines=' + JSON.stringify(Pipelines));
      return res.json(Data);
    }).catch(function (err) {
      var Error = err;
      // API call failed...
      console.log('User has %d repos', err);
    });
  },

  prepareRequest: function /*istanbul ignore next*/prepareRequest(options) {
    var res = options.response;
    var Configval = sails.config.constants.walson;
    console.log(Configval);
  },

  getRespectiveUrl: function /*istanbul ignore next*/getRespectiveUrl(CommandData) {

    var FinalUrl = '';

    var RepositoryId = 'repos/' + sails.config.constants.GitOwnerName + '/' + RepositoryName;

    var Issueurl = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo;
    var PipeLineurl = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo;

    var IssueEventsurl = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo + '/events';

    var MoveIssuePipeLine = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo + '/moves';
    var MoveBody = {
      pipeline_id: PipeLineId,
      position: PosNo !== null && PosNo !== '' && PosNo !== 'undefined' ? PosNo : 0
    };

    var EpicUrl = 'p1/repositories/' + RespositroyId + '/epics';

    var AddEstimateUrl = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo + '/estimate';
    var EstimateBody = {
      estimate: EstimateNo !== null && PosNo !== '' && PosNo !== 'undefined' ? EstimateNo : 0
    };

    switch (CommandData) {

      case '/blocked':
        FinalUrl = '';
        break;

      case '/epic':
        FinalUrl = '';
        break;

    }
  },

  getRespositoryId: function /*istanbul ignore next*/getRespositoryId(Options) {
    var res = Options.response;
    var req = Options.request;
    var RepositoryName = Options.repoName;
    var Ownername = sails.config.constants.GitOwnerName;

    var RepositoryUrl = 'repos/' + Ownername + '/' + RepositoryName;
    var MainUrl = sails.config.constants.GitHuburl;

    var UrlOptions = {
      uri: MainUrl + RepositoryUrl,
      qs: {
        //access_token: Token // -> uri + '?access_token=xxxxx%20xxxxx'
      },
      headers: {
        'User-Agent': 'Request-Promise'
      },
      json: true // Automatically parses the JSON string in the response
    };

    return rp(UrlOptions).then(function (successdata) {
      var RepoId = successdata.id;
      req.session.RepositoryId = RepoId;
      console.log('Repository Id=' + RepoId);
    }).catch(function (err) {
      var Error = err;
      // API call failed...
      console.log('User has %d repos', err);
    });
  },

  getRepoUrl: function /*istanbul ignore next*/getRepoUrl(UserCommand, CommandArr) {

    var RepositoryName = CommandArr[1];
    var RepositoryId = 'repos/' + sails.config.constants.GitOwnerName + '/' + RepositoryName;

    var UrlObject = {
      Url: RepositoryId,
      Method: 'GET',
      Body: null
    };

    return UrlObject;
  },

  getIssueUrl: function /*istanbul ignore next*/getIssueUrl(UserCommand, CommandArr, RepoId) {
    var RespositroyId = RepoId;

    var UrlObject = {
      Url: '',
      Method: 'GET',
      Body: null
    };

    //To Get State of Pipeline
    var PipelineRegex = new regex(/^\/issue*\s[0-9]*\spipeline/);

    if (PipelineRegex.test(UserCommand)) {

      var IssueNo = CommandArr[1];
      var PipeLineurl = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo;

      var UrlObject = {
        Url: PipeLineurl,
        Method: 'GET',
        Body: null
      };

      return UrlObject;
    }

    // Move Pipeline
    var PipelineMoveRegex = new regex(/^\/issue*\s[0-9]*\s-p\s[A-Za-z0-9]*/);

    if (PipelineMoveRegex.test(UserCommand)) {

      var IssueNo = CommandArr[1];
      var PipeLineId = CommandArr[3];
      var PosNo = CommandArr[4];

      var MoveIssuePipeLine = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo + '/moves';

      var MoveBody = {
        pipeline_id: PipeLineId,
        position: PosNo !== null && PosNo !== '' && PosNo !== 'undefined' ? PosNo : 0
      };

      var UrlObject = {
        Url: MoveIssuePipeLine,
        Method: 'POST',
        Body: MoveBody
      };

      return UrlObject;
    }

    // Get events for the Issue
    var EventsRegex = new regex(/^\/issue*\s[0-9]*\sevents/);

    if (EventsRegex.test(UserCommand)) {

      var IssueNo = CommandArr[1];
      var EstimateNo = CommandArr[3];

      var AddEstimateUrl = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo + '/estimate';
      var EstimateBody = {
        estimate: EstimateNo !== null && EstimateNo !== '' && EstimateNo !== 'undefined' ? EstimateNo : 0
      };

      var UrlObject = {
        Url: AddEstimateUrl,
        Method: 'PUT',
        Body: EstimateBody
      };

      return UrlObject;
    }

    // Get the estimate for the issue.
    var EstimateAddRegex = new regex(/^\/issue*\s[0-9]*\s-e\s[0-9]*/);

    if (EstimateAddRegex.test(UserCommand)) {

      var IssueNo = CommandArr[1];
      var PipeLineId = CommandArr[3];
      var PosNo = CommandArr[4];

      var MoveIssuePipeLine = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo + '/moves';

      var MoveBody = {
        pipeline_id: PipeLineId,
        position: PosNo !== null && PosNo !== '' && PosNo !== 'undefined' ? PosNo : 0
      };

      var UrlObject = {
        Url: MoveIssuePipeLine,
        Method: 'POST',
        Body: MoveBody
      };

      return UrlObject;
    }

    // Get Bugs by the user
    var BugRegex = new regex(/^\/issue*\s[0-9]*\sbug/);

    if (BugRegex.test(UserCommand)) {

      var IssueNo = CommandArr[1];

      var BugUrl = 'p1/repositories/' + RespositroyId + '/issues/' + IssueNo + '/estimate';

      var UrlObject = {
        Url: BugUrl,
        Method: 'GET',
        Body: null
      };

      return UrlObject;
    }

    //To Get User Issue by user
    var UserRegex = new regex(/^\/issue*\s[0-9]*\s-u\s[A-Za-z0-9]*/);

    if (UserRegex.test(UserCommand)) {

      var UserUrl = '';

      var UrlObject = {
        Url: UserUrl,
        Method: 'GET',
        Body: null
      };

      return UrlObject;
    }
  },

  getBlockUrl: function /*istanbul ignore next*/getBlockUrl(UserCommand, CommandArr) {

    var RepositoryName = CommandArr[1];
    var RepositoryId = 'repos/' + sails.config.constants.GitOwnerName + '/' + RepositoryName;

    var UrlObject = {
      Url: RepositoryId,
      Method: 'GET',
      Body: null
    };

    return UrlObject;
  }

};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9ib2FyZF9jb3B5LmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwicnAiLCJyZWdleCIsInJlcXVpcmVFbnYiLCJSZXBvUmVnZXgiLCJJc3N1ZVJlZ2V4IiwiRXBpY1JlZ2V4IiwiQmxvY2tlZFJlZ2V4IiwibW9kdWxlIiwiZXhwb3J0cyIsImNhbGxNZSIsIm9wdGlvbnMiLCJyZXEiLCJyZXF1ZXN0IiwicmVzIiwicmVzcG9uc2UiLCJ0ZXN0IiwiRmluYWxEYXRhIiwiY2hlY2tWYWxpZElucHV0IiwiVmFsaWRCaXQiLCJVc2VyQ29tbWFuZCIsInBhcmFtIiwiVmFsaWRDb21tYW5kcyIsIlZhbGlkQ29tbWFkUmVnZXgiLCJDb21tYW5kQXJyIiwic3BsaXQiLCJPcmlnaW5hbHNDb21tYW5kQXJyIiwic3BsaWNlIiwiRmluYWxDb21tYW5kIiwiam9pbiIsImdldENvbW1hbmQiLCJ2YWxpZGF0ZUNvbW1hbmRzIiwiUmVwb0lkIiwic2Vzc2lvbiIsInJlcG9pZCIsIkNvbW1hbmQiLCJVcmxPYmplY3QiLCJVcmwiLCJNZXRob2QiLCJCb2R5IiwiZ2V0UmVwb1VybCIsImdldElzc3VlVXJsIiwibWFrZVJlcXVlc3QiLCJJc3N1ZU51bSIsImlzc3VlIiwiVG9rZW4iLCJwcm9jZXNzIiwiZW52IiwiWkVOSFVCX1RPS0VOIiwiTWFpblVybCIsIkFjY2Vzc1Rva2VuIiwiVXNlclVybCIsIklzc3VlIiwiVXJsT3B0aW9ucyIsInVyaSIsInFzIiwiYWNjZXNzX3Rva2VuIiwiaGVhZGVycyIsImpzb24iLCJ0aGVuIiwicmVwb3MiLCJEYXRhIiwiSXNFcGljIiwiaXNfZXBpYyIsIlBpcGVsaW5lcyIsInBpcGVsaW5lIiwiY29uc29sZSIsImxvZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJjYXRjaCIsImVyciIsIkVycm9yIiwicHJlcGFyZVJlcXVlc3QiLCJDb25maWd2YWwiLCJzYWlscyIsImNvbmZpZyIsImNvbnN0YW50cyIsIndhbHNvbiIsImdldFJlc3BlY3RpdmVVcmwiLCJDb21tYW5kRGF0YSIsIkZpbmFsVXJsIiwiUmVwb3NpdG9yeUlkIiwiR2l0T3duZXJOYW1lIiwiUmVwb3NpdG9yeU5hbWUiLCJJc3N1ZXVybCIsIlJlc3Bvc2l0cm95SWQiLCJJc3N1ZU5vIiwiUGlwZUxpbmV1cmwiLCJJc3N1ZUV2ZW50c3VybCIsIk1vdmVJc3N1ZVBpcGVMaW5lIiwiTW92ZUJvZHkiLCJwaXBlbGluZV9pZCIsIlBpcGVMaW5lSWQiLCJwb3NpdGlvbiIsIlBvc05vIiwiRXBpY1VybCIsIkFkZEVzdGltYXRlVXJsIiwiRXN0aW1hdGVCb2R5IiwiZXN0aW1hdGUiLCJFc3RpbWF0ZU5vIiwiZ2V0UmVzcG9zaXRvcnlJZCIsIk9wdGlvbnMiLCJyZXBvTmFtZSIsIk93bmVybmFtZSIsIlJlcG9zaXRvcnlVcmwiLCJHaXRIdWJ1cmwiLCJzdWNjZXNzZGF0YSIsImlkIiwiUGlwZWxpbmVSZWdleCIsIlBpcGVsaW5lTW92ZVJlZ2V4IiwiRXZlbnRzUmVnZXgiLCJFc3RpbWF0ZUFkZFJlZ2V4IiwiQnVnUmVnZXgiLCJCdWdVcmwiLCJVc2VyUmVnZXgiLCJnZXRCbG9ja1VybCJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJQSxJQUFJQyxRQUFRLFFBQVIsQ0FBUjtBQUNBLElBQUlDLEtBQUtELFFBQVEsaUJBQVIsQ0FBVDtBQUNBLElBQUlFLFFBQVFGLFFBQVEsT0FBUixDQUFaO0FBQ0EsSUFBSUcsYUFBYUgsUUFBUSwrQkFBUixDQUFqQjs7QUFHQSxJQUFJSSxZQUFZLElBQUlGLEtBQUosQ0FBVSxnQ0FBVixDQUFoQjtBQUNBLElBQUlHLGFBQWEsSUFBSUgsS0FBSixDQUFVLHFEQUFWLENBQWpCO0FBQ0EsSUFBSUksWUFBWSxJQUFJSixLQUFKLENBQVUsMEJBQVYsQ0FBaEI7QUFDQSxJQUFJSyxlQUFlLElBQUlMLEtBQUosQ0FBVSxZQUFWLENBQW5COztBQUdBTSxPQUFPQyxPQUFQLEdBQWlCOztBQUdmQyxVQUFRLHdDQUFVQyxPQUFWLEVBQW1CO0FBQ3pCLFFBQUlDLE1BQU1ELFFB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LGNBQTFFOztBQUVBLFFBQUloRCxZQUFZO0FBQ2RDLFdBQUs2QyxZQURTO0FBRWQ1QyxjQUFRLEtBRk07QUFHZEMsWUFBTTtBQUhRLEtBQWhCOztBQU1BLFdBQU9ILFNBQVA7QUFDRDs7QUF0WmMsQ0FBakIiLCJmaWxlIjoiYm9hcmRfY29weS5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG52YXIgcnAgPSByZXF1aXJlKCdyZXF1ZXN0LXByb21pc2UnKTtcbnZhciByZWdleCA9IHJlcXVpcmUoJ3JlZ2V4Jyk7XG52YXIgcmVxdWlyZUVudiA9IHJlcXVpcmUoXCJyZXF1aXJlLWVudmlyb25tZW50LXZhcmlhYmxlc1wiKTtcblxuXG52YXIgUmVwb1JlZ2V4ID0gbmV3IHJlZ2V4KC9eXFwvcmVwbypcXHNbQS1aYS16MC05XSpcXHNbMC05XSovKTtcbnZhciBJc3N1ZVJlZ2V4ID0gbmV3IHJlZ2V4KC9eW1xcL2lzc3VlXSpcXHNbMC05XSpcXHMoLXV8YnVnfHBpcGVsaW5lfC1wfGV2ZW50c3wtZSkvKTtcbnZhciBFcGljUmVnZXggPSBuZXcgcmVnZXgoL15bXFwvZXBpY10qXFxzW0EtWmEtejAtOV0qLyk7XG52YXIgQmxvY2tlZFJlZ2V4ID0gbmV3IHJlZ2V4KC9eXFwvYmxvY2tlZC8pO1xuXG5cbm1vZHVsZS5leHBvcnRzID0ge1xuXG5cbiAgY2FsbE1lOiBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgIHZhciByZXEgPSBvcHRpb25zLnJlcXVlc3Q7XG4gICAgdmFyIHJlcyA9IG9wdGlvbnMucmVzcG9uc2U7XG4gICAgdmFyIHRlc3QgPSBvcHRpb25zLnRlc3Q7XG5cbiAgICB2YXIgRmluYWxEYXRhID0ge1xuICAgICAgXCJVc2VySWRcIjogXCJNYXBcIixcbiAgICAgIFwiQ2hlY2tcIjogdGVzdFxuICAgIH07XG5cbiAgICByZXR1cm4gRmluYWxEYXRhO1xuICB9LFxuXG4gIGNoZWNrVmFsaWRJbnB1dDogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICB2YXIgcmVxID0gb3B0aW9ucy5yZXF1ZXN0O1xuICAgIHZhciByZXMgPSBvcHRpb25zLnJlc3BvbnNlO1xuICAgIHZhciBWYWxpZEJpdCA9IGZhbHNlO1xuICAgIHZhciBVc2VyQ29tbWFuZCA9IHJlcS5wYXJhbSgnY29tbWFuZCcpO1xuICAgIHZhciBWYWxpZENvbW1hbmRzID0gWydAc2NydW1ib3QnLCAnL3JlcG8nLCAnL2lzc3VlJywgJy9lcGljJywgJy9ibG9ja2VkJ107XG5cbiAgICBpZiAoVXNlckNvbW1hbmQgPT09IG51bGwgfHwgVXNlckNvbW1hbmQgPT09ICcnIHx8IFVzZXJDb21tYW5kID09PSAndW5kZWZpbmVkJykge1xuICAgICAgcmV0dXJuIFZhbGlkQml0O1xuICAgIH1cblxuICAgIHZhciBWYWxpZENvbW1hZFJlZ2V4ID0gbmV3IHJlZ2V4KC9eKEBzY3J1bWJvdClcXHNbXFwvQS1aYS16XSovKTtcblxuICAgIGlmICghVmFsaWRDb21tYWRSZWdleC50ZXN0KFVzZXJDb21tYW5kKSlcbiAgICAgIHJldHVybiBWYWxpZEJpdDtcblxuICAgIHZhciBDb21tYW5kQXJyID0gVXNlckNvbW1hbmQuc3BsaXQoJyAnKTtcbiAgICB2YXIgT3JpZ2luYWxzQ29tbWFuZEFyciA9IENvbW1hbmRBcnI7XG4gICAgQ29tbWFuZEFyci5zcGxpY2UoMCk7XG4gICAgdmFyIEZpbmFsQ29tbWFuZCA9IENvbW1hbmRBcnIuam9pbignICcpO1xuXG4gICAgcmV0dXJuIFZhbGlkQml0ID0gdHJ1ZTtcblxuXG5cblxuXG4gICAgLy8gZm9yICh2YXIgaSA9IDA7IGkgPCBDb21tYW5kQXJyLmxlbmd0aDsgaSsrKSB7XG4gICAgLy8gICB2YXIgYWJjID0gQ29tbWFuZEFycltpXTtcbiAgICAvLyAgIGlmIChfLmluY2x1ZGVzKFZhbGlkQ29tbWFuZHMsIENvbW1hbmRBcnJbaV0pKSB7XG4gICAgLy8gICAgIFZhbGlkQml0ID0gdHJ1ZTtcbiAgICAvLyAgICAgLy9yZXR1cm4gdHJ1ZTtcbiAgICAvLyAgIH0gZWxzZSBpZiAoaSA9PSAyKSB7XG4gICAgLy8gICAgIHJldHVybiBmYWxzZTtcbiAgICAvLyAgIH0gZWxzZSB7XG4gICAgLy8gICAgIFZhbGlkQml0ID0gdHJ1ZTtcbiAgICAvLyAgICAgcmV0dXJuIGZhbHNlO1xuICAgIC8vICAgfVxuXG4gICAgLy8gfVxuXG4gICAgLy8gcmV0dXJuIFZhbGlkQml0O1xuICB9LFxuXG4gIGdldENvbW1hbmQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG5cbiAgICB2YXIgcmVxID0gb3B0aW9ucy5yZXF1ZXN0O1xuICAgIHZhciByZXMgPSBvcHRpb25zLnJlc3BvbnNlO1xuICAgIHZhciBWYWxpZEJpdCA9IGZhbHNlO1xuICAgIHZhciBVc2VyQ29tbWFuZCA9IHJlcS5wYXJhbSgnY29tbWFuZCcpO1xuXG5cbiAgICBpZiAoVXNlckNvbW1hbmQgPT09IG51bGwgfHwgVXNlckNvbW1hbmQgPT09ICcnIHx8IFVzZXJDb21tYW5kID09PSAndW5kZWZpbmVkJykge1xuICAgICAgcmV0dXJuIFZhbGlkQml0O1xuICAgIH1cblxuICAgIHZhciBDb21tYW5kQXJyID0gVXNlckNvbW1hbmQuc3BsaXQoJyAnKTtcbiAgICB2YXIgT3JpZ2luYWxzQ29tbWFuZEFyciA9IENvbW1hbmRBcnI7XG4gICAgQ29tbWFuZEFyci5zcGxpY2UoMCk7XG4gICAgdmFyIEZpbmFsQ29tbWFuZCA9IENvbW1hbmRBcnIuam9pbignICcpO1xuXG4gICAgcmV0dXJuIEZpbmFsQ29tbWFuZDtcbiAgfSxcblxuICB2YWxpZGF0ZUNvbW1hbmRzOiBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgIHZhciByZXEgPSBvcHRpb25zLnJlcXVlc3Q7XG4gICAgdmFyIHJlcyA9IG9wdGlvbnMucmVzcG9uc2U7XG4gICAgdmFyIFZhbGlkQml0ID0gZmFsc2U7XG5cbiAgICB2YXIgUmVwb0lkPXJlcS5zZXNzaW9uLnJlcG9pZDtcbiAgICBcbiAgICB2YXIgVXNlckNvbW1hbmQgPSBvcHRpb25zLkNvbW1hbmQ7XG4gICAgdmFyIENvbW1hbmRBcnIgPSBVc2VyQ29tbWFuZC5zcGxpdCgnICcpO1xuICAgIHZhciBVcmxPYmplY3QgPSB7XG4gICAgICBVcmw6ICcnLFxuICAgICAgTWV0aG9kOiAnR0VUJyxcbiAgICAgIEJvZHkgOiBudWxsXG4gICAgfTtcblxuICBcblxuICAgIGlmIChSZXBvUmVnZXgudGVzdChVc2VyQ29tbWFuZCkpXG4gICAgICByZXR1cm4gVXJsT2JqZWN0ID0gZ2V0UmVwb1VybChVc2VyQ29tbWFuZCwgQ29tbWFuZEFycik7XG5cbiAgICBpZiAoQmxvY2tlZFJlZ2V4LnRlc3QoVXNlckNvbW1hbmQpKVxuICAgICAgcmV0dXJuIFVybCA9ICdwMS9yZXBvc2l0b3JpZXMvJztcblxuICAgIGlmIChJc3N1ZVJlZ2V4LnRlc3QoVXNlckNvbW1hbmQpKVxuICAgICAgcmV0dXJuIFVybCA9IGdldElzc3VlVXJsKFVzZXJDb21tYW5kLCBDb21tYW5kQXJyLFJlcG9JZCk7XG5cbiAgfSxcbiAgbWFrZVJlcXVlc3Q6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgdmFyIHJlcyA9IG9wdGlvbnMucmVzcG9uc2U7XG4gICAgdmFyIElzc3VlTnVtID0gb3B0aW9ucy5pc3N1ZTtcbiAgICB2YXIgVG9rZW4gPSBwcm9jZXNzLmVudi5aRU5IVUJfVE9LRU47XG4gICAgdmFyIE1haW5VcmwgPSAnaHR0cHM6Ly9hcGkuemVuaHViLmlvLyc7XG4gICAgdmFyIEFjY2Vzc1Rva2VuID0gJ2FjY2Vzc190b2tlbj0nICsgVG9rZW47XG4gICAgdmFyIFVzZXJVcmwgPSAncDEvcmVwb3NpdG9yaWVzLzExNzEyNDA1My9pc3N1ZXMvJytJc3N1ZTtcblxuXG5cbiAgICB2YXIgVXJsT3B0aW9ucyA9IHtcbiAgICAgIHVyaTogTWFpblVybCArIFVzZXJVcmwsXG4gICAgICBxczoge1xuICAgICAgICBhY2Nlc3NfdG9rZW46IFRva2VuIC8vIC0+IHVyaSArICc/YWNjZXNzX3Rva2VuPXh4eHh4JTIweHh4eHgnXG4gICAgICB9LFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnVXNlci1BZ2VudCc6ICdSZXF1ZXN0LVByb21pc2UnXG4gICAgICB9LFxuICAgICAganNvbjogdHJ1ZSAvLyBBdXRvbWF0aWNhbGx5IHBhcnNlcyB0aGUgSlNPTiBzdHJpbmcgaW4gdGhlIHJlc3BvbnNlXG4gICAgfTtcblxuICAgIHJldHVybiBycChVcmxPcHRpb25zKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKHJlcG9zKSB7XG4gICAgICAgIHZhciBEYXRhID0gcmVwb3M7XG4gICAgICAgIHZhciBJc0VwaWMgPSBEYXRhLmlzX2VwaWM7XG4gICAgICAgIHZhciBQaXBlbGluZXMgPSBEYXRhLnBpcGVsaW5lO1xuICAgICAgICBjb25zb2xlLmxvZygnVXNlciBoYXMgUGlwZWxpbmVzPScgKyBKU09OLnN0cmluZ2lmeShQaXBlbGluZXMpKTtcbiAgICAgICAgcmV0dXJuIHJlcy5qc29uKERhdGEpO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgIHZhciBFcnJvciA9IGVycjtcbiAgICAgICAgLy8gQVBJIGNhbGwgZmFpbGVkLi4uXG4gICAgICAgIGNvbnNvbGUubG9nKCdVc2VyIGhhcyAlZCByZXBvcycsIGVycik7XG4gICAgICB9KTtcblxuXG4gIH0sXG5cbiAgcHJlcGFyZVJlcXVlc3Q6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICB2YXIgcmVzID0gb3B0aW9ucy5yZXNwb25zZTtcbiAgICAgIHZhciBDb25maWd2YWwgPSBzYWlscy5jb25maWcuY29uc3RhbnRzLndhbHNvbjtcbiAgICAgIGNvbnNvbGUubG9nKENvbmZpZ3ZhbCk7XG5cblxuICAgIH1cblxuICAgICxcblxuICBnZXRSZXNwZWN0aXZlVXJsOiBmdW5jdGlvbiAoQ29tbWFuZERhdGEpIHtcblxuICAgIHZhciBGaW5hbFVybCA9ICcnO1xuXG4gICAgdmFyIFJlcG9zaXRvcnlJZCA9ICdyZXBvcy8nICsgc2FpbHMuY29uZmlnLmNvbnN0YW50cy5HaXRPd25lck5hbWUgKyAnLycgKyBSZXBvc2l0b3J5TmFtZTtcblxuICAgIHZhciBJc3N1ZXVybCA9ICdwMS9yZXBvc2l0b3JpZXMvJyArIFJlc3Bvc2l0cm95SWQgKyAnL2lzc3Vlcy8nICsgSXNzdWVObztcbiAgICB2YXIgUGlwZUxpbmV1cmwgPSAncDEvcmVwb3NpdG9yaWVzLycgKyBSZXNwb3NpdHJveUlkICsgJy9pc3N1ZXMvJyArIElzc3VlTm87XG5cbiAgICB2YXIgSXNzdWVFdmVudHN1cmwgPSAncDEvcmVwb3NpdG9yaWVzLycgKyBSZXNwb3NpdHJveUlkICsgJy9pc3N1ZXMvJyArIElzc3VlTm8gKyAnL2V2ZW50cyc7XG5cbiAgICB2YXIgTW92ZUlzc3VlUGlwZUxpbmUgPSAncDEvcmVwb3NpdG9yaWVzLycgKyBSZXNwb3NpdHJveUlkICsgJy9pc3N1ZXMvJyArIElzc3VlTm8gKyAnL21vdmVzJztcbiAgICB2YXIgTW92ZUJvZHkgPSB7XG4gICAgICBwaXBlbGluZV9pZDogUGlwZUxpbmVJZCxcbiAgICAgIHBvc2l0aW9uOiAoUG9zTm8gIT09IG51bGwgJiYgUG9zTm8gIT09ICcnICYmIFBvc05vICE9PSAndW5kZWZpbmVkJyA/IFBvc05vIDogMClcbiAgICB9O1xuXG5cbiAgICB2YXIgRXBpY1VybCA9ICdwMS9yZXBvc2l0b3JpZXMvJyArIFJlc3Bvc2l0cm95SWQgKyAnL2VwaWNzJztcblxuICAgIHZhciBBZGRFc3RpbWF0ZVVybCA9ICdwMS9yZXBvc2l0b3JpZXMvJyArIFJlc3Bvc2l0cm95SWQgKyAnL2lzc3Vlcy8nICsgSXNzdWVObyArICcvZXN0aW1hdGUnO1xuICAgIHZhciBFc3RpbWF0ZUJvZHkgPSB7XG4gICAgICBlc3RpbWF0ZTogKEVzdGltYXRlTm8gIT09IG51bGwgJiYgUG9zTm8gIT09ICcnICYmIFBvc05vICE9PSAndW5kZWZpbmVkJyA/IEVzdGltYXRlTm8gOiAwKVxuICAgIH07XG5cblxuXG4gICAgc3dpdGNoIChDb21tYW5kRGF0YSkge1xuXG5cblxuICAgICAgY2FzZSAnL2Jsb2NrZWQnOlxuICAgICAgICBGaW5hbFVybCA9ICcnO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnL2VwaWMnOlxuICAgICAgICBGaW5hbFVybCA9ICcnO1xuICAgICAgICBicmVhaztcblxuICAgIH1cblxuICB9LFxuXG4gIGdldFJlc3Bvc2l0b3J5SWQ6IGZ1bmN0aW9uIChPcHRpb25zKSB7XG4gICAgdmFyIHJlcyA9IE9wdGlvbnMucmVzcG9uc2U7XG4gICAgdmFyIHJlcSA9IE9wdGlvbnMucmVxdWVzdDtcbiAgICB2YXIgUmVwb3NpdG9yeU5hbWUgPSBPcHRpb25zLnJlcG9OYW1lO1xuICAgIHZhciBPd25lcm5hbWUgPSBzYWlscy5jb25maWcuY29uc3RhbnRzLkdpdE93bmVyTmFtZTtcblxuICAgIHZhciBSZXBvc2l0b3J5VXJsID0gJ3JlcG9zLycgKyBPd25lcm5hbWUgKyAnLycgKyBSZXBvc2l0b3J5TmFtZTtcbiAgICB2YXIgTWFpblVybCA9IHNhaWxzLmNvbmZpZy5jb25zdGFudHMuR2l0SHVidXJsO1xuXG4gICAgdmFyIFVybE9wdGlvbnMgPSB7XG4gICAgICB1cmk6IE1haW5VcmwgKyBSZXBvc2l0b3J5VXJsLFxuICAgICAgcXM6IHtcbiAgICAgICAgLy9hY2Nlc3NfdG9rZW46IFRva2VuIC8vIC0+IHVyaSArICc/YWNjZXNzX3Rva2VuPXh4eHh4JTIweHh4eHgnXG4gICAgICB9LFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnVXNlci1BZ2VudCc6ICdSZXF1ZXN0LVByb21pc2UnXG4gICAgICB9LFxuICAgICAganNvbjogdHJ1ZSAvLyBBdXRvbWF0aWNhbGx5IHBhcnNlcyB0aGUgSlNPTiBzdHJpbmcgaW4gdGhlIHJlc3BvbnNlXG4gICAgfTtcblxuICAgIHJldHVybiBycChVcmxPcHRpb25zKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKHN1Y2Nlc3NkYXRhKSB7XG4gICAgICAgIHZhciBSZXBvSWQgPSBzdWNjZXNzZGF0YS5pZDtcbiAgICAgICAgcmVxLnNlc3Npb24uUmVwb3NpdG9yeUlkID0gUmVwb0lkO1xuICAgICAgICBjb25zb2xlLmxvZygnUmVwb3NpdG9yeSBJZD0nICsgUmVwb0lkKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICB2YXIgRXJyb3IgPSBlcnI7XG4gICAgICAgIC8vIEFQSSBjYWxsIGZhaWxlZC4uLlxuICAgICAgICBjb25zb2xlLmxvZygnVXNlciBoYXMgJWQgcmVwb3MnLCBlcnIpO1xuICAgICAgfSk7XG5cbiAgfSxcblxuICBnZXRSZXBvVXJsOiBmdW5jdGlvbiAoVXNlckNvbW1hbmQsIENvbW1hbmRBcnIpIHtcblxuICAgIHZhciBSZXBvc2l0b3J5TmFtZSA9IENvbW1hbmRBcnJbMV07XG4gICAgdmFyIFJlcG9zaXRvcnlJZCA9ICdyZXBvcy8nICsgc2FpbHMuY29uZmlnLmNvbnN0YW50cy5HaXRPd25lck5hbWUgKyAnLycgKyBSZXBvc2l0b3J5TmFtZTtcblxuICAgIHZhciBVcmxPYmplY3QgPSB7XG4gICAgICBVcmw6IFJlcG9zaXRvcnlJZCxcbiAgICAgIE1ldGhvZDogJ0dFVCcsXG4gICAgICBCb2R5OiBudWxsXG4gICAgfTtcblxuICAgIHJldHVybiBVcmxPYmplY3Q7XG4gIH0sXG5cbiAgZ2V0SXNzdWVVcmw6IGZ1bmN0aW9uIChVc2VyQ29tbWFuZCwgQ29tbWFuZEFycixSZXBvSWQpIHtcbiAgICB2YXIgUmVzcG9zaXRyb3lJZCA9IFJlcG9JZDtcblxuICAgIHZhciBVcmxPYmplY3QgPSB7XG4gICAgICBVcmw6ICcnLFxuICAgICAgTWV0aG9kOiAnR0VUJyxcbiAgICAgIEJvZHk6IG51bGxcbiAgICB9O1xuXG5cblxuXG4gICAgLy9UbyBHZXQgU3RhdGUgb2YgUGlwZWxpbmVcbiAgICB2YXIgUGlwZWxpbmVSZWdleCA9IG5ldyByZWdleCgvXlxcL2lzc3VlKlxcc1swLTldKlxcc3BpcGVsaW5lLyk7XG5cbiAgICBpZiAoUGlwZWxpbmVSZWdleC50ZXN0KFVzZXJDb21tYW5kKSkge1xuXG4gICAgICB2YXIgSXNzdWVObyA9IENvbW1hbmRBcnJbMV07XG4gICAgICB2YXIgUGlwZUxpbmV1cmwgPSAncDEvcmVwb3NpdG9yaWVzLycgKyBSZXNwb3NpdHJveUlkICsgJy9pc3N1ZXMvJyArIElzc3VlTm87XG5cbiAgICAgIHZhciBVcmxPYmplY3QgPSB7XG4gICAgICAgIFVybDogUGlwZUxpbmV1cmwsXG4gICAgICAgIE1ldGhvZDogJ0dFVCcsXG4gICAgICAgIEJvZHk6IG51bGxcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiBVcmxPYmplY3Q7XG4gICAgfVxuXG5cbiAgICAvLyBNb3ZlIFBpcGVsaW5lXG4gICAgdmFyIFBpcGVsaW5lTW92ZVJlZ2V4ID0gbmV3IHJlZ2V4KC9eXFwvaXNzdWUqXFxzWzAtOV0qXFxzLXBcXHNbQS1aYS16MC05XSovKTtcblxuICAgIGlmIChQaXBlbGluZU1vdmVSZWdleC50ZXN0KFVzZXJDb21tYW5kKSkge1xuXG4gICAgICB2YXIgSXNzdWVObyA9IENvbW1hbmRBcnJbMV07XG4gICAgICB2YXIgUGlwZUxpbmVJZCA9IENvbW1hbmRBcnJbM107XG4gICAgICB2YXIgUG9zTm8gPSBDb21tYW5kQXJyWzRdO1xuXG4gICAgICB2YXIgTW92ZUlzc3VlUGlwZUxpbmUgPSAncDEvcmVwb3NpdG9yaWVzLycgKyBSZXNwb3NpdHJveUlkICsgJy9pc3N1ZXMvJyArIElzc3VlTm8gKyAnL21vdmVzJztcblxuICAgICAgdmFyIE1vdmVCb2R5ID0ge1xuICAgICAgICBwaXBlbGluZV9pZDogUGlwZUxpbmVJZCxcbiAgICAgICAgcG9zaXRpb246IChQb3NObyAhPT0gbnVsbCAmJiBQb3NObyAhPT0gJycgJiYgUG9zTm8gIT09ICd1bmRlZmluZWQnID8gUG9zTm8gOiAwKVxuICAgICAgfTtcblxuICAgICAgdmFyIFVybE9iamVjdCA9IHtcbiAgICAgICAgVXJsOiBNb3ZlSXNzdWVQaXBlTGluZSxcbiAgICAgICAgTWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIEJvZHk6IE1vdmVCb2R5XG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gVXJsT2JqZWN0O1xuICAgIH1cblxuXG4gICAgLy8gR2V0IGV2ZW50cyBmb3IgdGhlIElzc3VlXG4gICAgdmFyIEV2ZW50c1JlZ2V4ID0gbmV3IHJlZ2V4KC9eXFwvaXNzdWUqXFxzWzAtOV0qXFxzZXZlbnRzLyk7XG5cbiAgICBpZiAoRXZlbnRzUmVnZXgudGVzdChVc2VyQ29tbWFuZCkpIHtcblxuICAgICAgdmFyIElzc3VlTm8gPSBDb21tYW5kQXJyWzFdO1xuICAgICAgdmFyIEVzdGltYXRlTm8gPSBDb21tYW5kQXJyWzNdO1xuXG4gICAgICB2YXIgQWRkRXN0aW1hdGVVcmwgPSAncDEvcmVwb3NpdG9yaWVzLycgKyBSZXNwb3NpdHJveUlkICsgJy9pc3N1ZXMvJyArIElzc3VlTm8gKyAnL2VzdGltYXRlJztcbiAgICAgIHZhciBFc3RpbWF0ZUJvZHkgPSB7XG4gICAgICAgIGVzdGltYXRlOiAoRXN0aW1hdGVObyAhPT0gbnVsbCAmJiBFc3RpbWF0ZU5vICE9PSAnJyAmJiBFc3RpbWF0ZU5vICE9PSAndW5kZWZpbmVkJyA/IEVzdGltYXRlTm8gOiAwKVxuICAgICAgfTtcblxuICAgICAgdmFyIFVybE9iamVjdCA9IHtcbiAgICAgICAgVXJsOiBBZGRFc3RpbWF0ZVVybCxcbiAgICAgICAgTWV0aG9kOiAnUFVUJyxcbiAgICAgICAgQm9keTogRXN0aW1hdGVCb2R5XG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gVXJsT2JqZWN0O1xuICAgIH1cblxuXG5cbiAgICAvLyBHZXQgdGhlIGVzdGltYXRlIGZvciB0aGUgaXNzdWUuXG4gICAgdmFyIEVzdGltYXRlQWRkUmVnZXggPSBuZXcgcmVnZXgoL15cXC9pc3N1ZSpcXHNbMC05XSpcXHMtZVxcc1swLTldKi8pO1xuXG4gICAgaWYgKEVzdGltYXRlQWRkUmVnZXgudGVzdChVc2VyQ29tbWFuZCkpIHtcblxuICAgICAgdmFyIElzc3VlTm8gPSBDb21tYW5kQXJyWzFdO1xuICAgICAgdmFyIFBpcGVMaW5lSWQgPSBDb21tYW5kQXJyWzNdO1xuICAgICAgdmFyIFBvc05vID0gQ29tbWFuZEFycls0XTtcblxuICAgICAgdmFyIE1vdmVJc3N1ZVBpcGVMaW5lID0gJ3AxL3JlcG9zaXRvcmllcy8nICsgUmVzcG9zaXRyb3lJZCArICcvaXNzdWVzLycgKyBJc3N1ZU5vICsgJy9tb3Zlcyc7XG5cbiAgICAgIHZhciBNb3ZlQm9keSA9IHtcbiAgICAgICAgcGlwZWxpbmVfaWQ6IFBpcGVMaW5lSWQsXG4gICAgICAgIHBvc2l0aW9uOiAoUG9zTm8gIT09IG51bGwgJiYgUG9zTm8gIT09ICcnICYmIFBvc05vICE9PSAndW5kZWZpbmVkJyA/IFBvc05vIDogMClcbiAgICAgIH07XG5cbiAgICAgIHZhciBVcmxPYmplY3QgPSB7XG4gICAgICAgIFVybDogTW92ZUlzc3VlUGlwZUxpbmUsXG4gICAgICAgIE1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBCb2R5OiBNb3ZlQm9keVxuICAgICAgfTtcblxuICAgICAgcmV0dXJuIFVybE9iamVjdDtcbiAgICB9XG5cblxuXG4gICAgLy8gR2V0IEJ1Z3MgYnkgdGhlIHVzZXJcbiAgICB2YXIgQnVnUmVnZXggPSBuZXcgcmVnZXgoL15cXC9pc3N1ZSpcXHNbMC05XSpcXHNidWcvKTtcblxuICAgIGlmIChCdWdSZWdleC50ZXN0KFVzZXJDb21tYW5kKSkge1xuXG4gICAgICB2YXIgSXNzdWVObyA9IENvbW1hbmRBcnJbMV07XG5cbiAgICAgIHZhciBCdWdVcmwgPSAncDEvcmVwb3NpdG9yaWVzLycgKyBSZXNwb3NpdHJveUlkICsgJy9pc3N1ZXMvJyArIElzc3VlTm8gKyAnL2VzdGltYXRlJztcblxuICAgICAgdmFyIFVybE9iamVjdCA9IHtcbiAgICAgICAgVXJsOiBCdWdVcmwsXG4gICAgICAgIE1ldGhvZDogJ0dFVCcsXG4gICAgICAgIEJvZHk6IG51bGxcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiBVcmxPYmplY3Q7XG4gICAgfVxuXG5cbiAgICAvL1RvIEdldCBVc2VyIElzc3VlIGJ5IHVzZXJcbiAgICB2YXIgVXNlclJlZ2V4ID0gbmV3IHJlZ2V4KC9eXFwvaXNzdWUqXFxzWzAtOV0qXFxzLXVcXHNbQS1aYS16MC05XSovKTtcblxuICAgIGlmIChVc2VyUmVnZXgudGVzdChVc2VyQ29tbWFuZCkpIHtcblxuICAgICAgdmFyIFVzZXJVcmwgPSAnJztcblxuICAgICAgdmFyIFVybE9iamVjdCA9IHtcbiAgICAgICAgVXJsOiBVc2VyVXJsLFxuICAgICAgICBNZXRob2Q6ICdHRVQnLFxuICAgICAgICBCb2R5OiBudWxsXG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gVXJsT2JqZWN0O1xuICAgIH1cblxuXG5cbiAgfVxuXG4gICxcblxuICBnZXRCbG9ja1VybDogZnVuY3Rpb24gKFVzZXJDb21tYW5kLCBDb21tYW5kQXJyKSB7XG5cbiAgICB2YXIgUmVwb3NpdG9yeU5hbWUgPSBDb21tYW5kQXJyWzFdO1xuICAgIHZhciBSZXBvc2l0b3J5SWQgPSAncmVwb3MvJyArIHNhaWxzLmNvbmZpZy5jb25zdGFudHMuR2l0T3duZXJOYW1lICsgJy8nICsgUmVwb3NpdG9yeU5hbWU7XG5cbiAgICB2YXIgVXJsT2JqZWN0ID0ge1xuICAgICAgVXJsOiBSZXBvc2l0b3J5SWQsXG4gICAgICBNZXRob2Q6ICdHRVQnLFxuICAgICAgQm9keTogbnVsbFxuICAgIH07XG5cbiAgICByZXR1cm4gVXJsT2JqZWN0O1xuICB9LFxuXG5cblxufTtcbiJdfQ==